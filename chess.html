<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arnav Verse | Chess Arena</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CYBERPUNK UNIVERSE --- */
        body {
            background-color: #050505;
            color: #fff;
            font-family: 'Courier New', monospace;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100vh; margin: 0; overflow: hidden;
            background-image: radial-gradient(circle at center, #111 0%, #000 100%);
        }

        /* --- ðŸ¤– PRO BOT PROFILE (UPGRADED) --- */
        .opponent-area {
            display: flex; align-items: center; gap: 20px; margin-bottom: 20px;
            width: 420px;
            padding: 15px;
            background: rgba(20, 20, 20, 0.8);
            border: 1px solid #333;
            border-left: 4px solid #00ff88; /* Neon Green Accent */
            border-radius: 0 10px 10px 0;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            position: relative;
        }

        /* Glitchy Avatar Container */
        .avatar-container {
            position: relative; width: 70px; height: 70px;
        }
        .bot-avatar {
            width: 100%; height: 100%; border-radius: 10px;
            background: #000; border: 2px solid #00ff88;
            display: flex; align-items: center; justify-content: center;
            font-size: 35px; color: #00ff88;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
            z-index: 2; position: relative;
        }
        /* Scanning Line Effect */
        .bot-avatar::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: #fff; opacity: 0.5;
            animation: scan 2s linear infinite;
        }

        .bot-info { flex: 1; }
        .bot-info h3 { 
            margin: 0; font-size: 1.4rem; color: #fff; 
            text-transform: uppercase; letter-spacing: 2px;
            text-shadow: 0 0 5px rgba(255,255,255,0.5);
        }
        .bot-stats {
            display: flex; gap: 10px; font-size: 0.75rem; color: #888; margin-top: 5px;
        }
        .stat-badge {
            background: #111; padding: 2px 6px; border-radius: 4px; border: 1px solid #333;
        }
        .stat-badge.active { border-color: #00ff88; color: #00ff88; }

        /* Thinking Indicator */
        .thinking-indicator {
            position: absolute; right: 15px; top: 15px;
            width: 10px; height: 10px; background: #ff4b4b; border-radius: 50%;
            box-shadow: 0 0 10px #ff4b4b; opacity: 0.2; transition: 0.3s;
        }
        .thinking-indicator.thinking {
            background: #00a3ff; box-shadow: 0 0 15px #00a3ff; opacity: 1;
            animation: pulse 0.5s infinite alternate;
        }

        /* The Speech Bubble */
        .speech-bubble {
            margin-top: 10px;
            font-size: 0.85rem; color: #00ff88;
            font-style: italic; min-height: 20px;
        }

        /* --- CHESS BOARD --- */
        #myBoard {
            width: 420px;
            border: 5px solid #222;
            box-shadow: 0 0 50px rgba(0, 255, 136, 0.1);
        }
        .white-1e1d7 { background-color: #dadada; color: #b58863; }
        .black-3c85d { background-color: #363636; color: #f0d9b5; }

        /* Controls */
        .controls { margin-top: 25px; display: flex; gap: 20px; }
        .btn {
            background: transparent; border: 1px solid #00a3ff; color: #00a3ff;
            padding: 10px 25px; cursor: pointer; text-transform: uppercase;
            font-family: inherit; font-weight: bold; font-size: 0.9rem; transition: 0.3s;
            letter-spacing: 1px;
        }
        .btn:hover { background: #00a3ff; color: #000; box-shadow: 0 0 20px rgba(0, 163, 255, 0.6); }
        .btn-exit { border-color: #ff4b4b; color: #ff4b4b; text-decoration: none; display: flex; align-items: center; justify-content: center; }
        .btn-exit:hover { background: #ff4b4b; color: #fff; box-shadow: 0 0 20px rgba(255, 75, 75, 0.6); }

        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.3); } }

        @media (max-width: 500px) {
            #myBoard, .opponent-area { width: 340px; }
        }
    </style>
</head>
<body>

    <div class="opponent-area">
        <div class="avatar-container">
            <div class="bot-avatar">
                <i class="fas fa-robot"></i>
            </div>
        </div>
        <div class="bot-info">
            <h3>Arnav's Bot</h3>
            <div class="bot-stats">
                <span class="stat-badge active">ENGINE: STOCKFISH 15</span>
                <span class="stat-badge">ELO: 2000</span>
            </div>
            <div class="speech-bubble" id="bot-msg">"Initializing neural network... ðŸ§ "</div>
        </div>
        <div class="thinking-indicator" id="brain-light"></div>
    </div>

    <div id="myBoard"></div>

    <div class="controls">
        <a href="index.html" class="btn btn-exit"><i class="fas fa-arrow-left"></i> &nbsp;Exit</a>
        <button class="btn" onclick="resetGame()">Restart <i class="fas fa-redo"></i></button>
    </div>

    <script>
        var board = null;
        var game = new Chess();
        var stockfish = null;
        var isEngineReady = false;
        
        // Sounds
        var moveSound = new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_common/move-self.mp3');
        var captureSound = new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_common/capture.mp3');

        // --- 1. STOCKFISH INTEGRATION (The Hacker Way) ---
        // We fetch the script code and create a local worker to bypass CORS issues
        async function initStockfish() {
            try {
                const response = await fetch('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js');
                const scriptContent = await response.text();
                const blob = new Blob([scriptContent], { type: 'application/javascript' });
                const workerUrl = URL.createObjectURL(blob);
                
                stockfish = new Worker(workerUrl);
                
                stockfish.onmessage = function(event) {
                    const msg = event.data;
                    
                    // Engine Ready Check
                    if (msg === 'uciok') {
                        isEngineReady = true;
                        speak("ready");
                    }
                    
                    // Engine Move Result
                    if (msg.startsWith('bestmove')) {
                        const move = msg.split(' ')[1];
                        makeEngineMove(move);
                    }
                };

                stockfish.postMessage('uci');
                stockfish.postMessage('ucinewgame');
                stockfish.postMessage('isready');
                
            } catch (e) {
                console.error("Stockfish failed to load", e);
                speak("error");
            }
        }
        initStockfish();

        // --- 2. DIALOGUE SYSTEM (Roast & Praise) ---
        const dialogues = {
            ready: ["Engine calibrated. Good luck. ðŸ’€", "I see everything. Your move.", "Don't bore me."],
            thinking: ["Calculating your demise...", "Processing stupid move...", "Analyzing..."],
            goodMove: ["Not bad. You read a book?", "Impressive... for a human.", "Hmm, unexpected."],
            badMove: ["That was a blunder. ðŸ¤£", "Did you slip?", "My algorithm is laughing.", "Free piece? Don't mind if I do."],
            check: ["Check. Darr lag raha hai?", "King is sweating.", "Careful now."],
            winning: ["It's mate in 10. Resign?", "Game over soon.", "Resistance is futile."],
            error: ["Brain glitch... Refresh page.", "System overload."]
        };

        function speak(category) {
            const msgs = dialogues[category];
            if(!msgs) return;
            const msg = msgs[Math.floor(Math.random() * msgs.length)];
            const bubble = document.getElementById('bot-msg');
            
            bubble.style.opacity = '0';
            setTimeout(() => {
                bubble.innerText = msg;
                bubble.style.opacity = '1';
                // Color logic
                if(category === 'badMove' || category === 'winning') bubble.style.color = '#ff4b4b'; // Red
                else if(category === 'goodMove') bubble.style.color = '#00a3ff'; // Blue
                else bubble.style.color = '#00ff88'; // Green
            }, 200);
        }

        // --- 3. GAME LOGIC ---
        function onDragStart (source, piece) {
            if (game.game_over() || !isEngineReady) return false;
            if (piece.search(/^b/) !== -1) return false; // Only play White
        }

        function onDrop (source, target) {
            // Validate Move
            var move = game.move({
                from: source,
                to: target,
                promotion: 'q'
            });

            if (move === null) return 'snapback';

            // React to User Move
            if (move.captured) {
                captureSound.play();
                speak("goodMove");
            } else if (game.in_check()) {
                moveSound.play();
                speak("check");
            } else {
                moveSound.play();
            }

            // Trigger Stockfish
            if (!game.game_over()) {
                document.getElementById('brain-light').classList.add('thinking'); // Light ON
                // speak("thinking"); // Too chatty? Maybe mute this
                
                // Send position to Stockfish
                // Skill Level: We give it 1 second to think (Strong but beatable by pros)
                // Or set depth to 10-15
                stockfish.postMessage('position fen ' + game.fen());
                stockfish.postMessage('go depth 10'); 
            }
        }

        function onSnapEnd () {
            board.position(game.fen());
        }

        // --- 4. ENGINE MOVE EXECUTION ---
        function makeEngineMove(bestMove) {
            document.getElementById('brain-light').classList.remove('thinking'); // Light OFF
            
            if(!bestMove) return;

            const from = bestMove.substring(0, 2);
            const to = bestMove.substring(2, 4);
            
            // Execute move
            const move = game.move({
                from: from,
                to: to,
                promotion: 'q'
            });

            board.position(game.fen());

            // React to Bot Move
            if (move.captured) {
                captureSound.play();
                speak("badMove"); // Bot captured your piece -> Roast
            } else if (game.in_check()) {
                moveSound.play();
                speak("check");
            } else {
                moveSound.play();
            }

            if (game.game_over()) {
                if(game.in_checkmate()) speak("winning");
                alert("Game Over! Arnav Bot Wins. ðŸ’€");
            }
        }

        function resetGame() {
            game.reset();
            board.start();
            speak("ready");
            if(stockfish) stockfish.postMessage('ucinewgame');
        }

        var config = {
            draggable: true,
            position: 'start',
            onDragStart: onDragStart,
            onDrop: onDrop,
            onSnapEnd: onSnapEnd,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        }
        board = Chessboard('myBoard', config);
        window.addEventListener('resize', board.resize);

    </script>
</body>
</html>
